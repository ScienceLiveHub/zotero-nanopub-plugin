name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build nanopub-view dependency
        run: |
          echo "ðŸ“¦ Building nanopub-view library from GitHub..."
          cd node_modules/@sciencelivehub/nanopub-view
          
          npm install
          
          cat > vite.lib.config.js << 'VITE_EOF'
          import { defineConfig } from 'vite';
          import path from 'path';
          
          export default defineConfig({
            build: {
              lib: {
                entry: path.resolve(__dirname, 'src/index.js'),
                name: 'NanopubViewer',
                formats: ['es', 'umd'],
                fileName: (format) => {
                  if (format === 'es') return 'nanopub-viewer.esm.js';
                  if (format === 'umd') return 'nanopub-viewer.js';
                }
              },
              rollupOptions: {
                output: {
                  assetFileNames: (assetInfo) => {
                    if (assetInfo.name === 'style.css') return 'nanopub-viewer.css';
                    return assetInfo.name;
                  }
                }
              }
            }
          });
          VITE_EOF
          
          npx vite build --config vite.lib.config.js
          
          cd ../../..
          
          echo "âœ… nanopub-view built successfully"
          ls -lah node_modules/@sciencelivehub/nanopub-view/dist/
      
      - name: Build nanopub-create dependency
        run: |
          echo "ðŸ“¦ Building nanopub-create library from GitHub..."
          cd node_modules/@sciencelivehub/nanopub-create
          
          # Install dependencies
          npm install
          
          # Create a temporary library-only vite config
          cat > vite.lib.config.js << 'VITE_EOF'
          import { defineConfig } from 'vite';
          import path from 'path';
          import wasm from 'vite-plugin-wasm';
          import topLevelAwait from 'vite-plugin-top-level-await';
          
          export default defineConfig({
            plugins: [
              wasm(),
              topLevelAwait()
            ],
            build: {
              lib: {
                entry: path.resolve(__dirname, 'src/index.js'),
                name: 'NanopubCreator',
                formats: ['es', 'umd'],
                fileName: (format) => {
                  if (format === 'es') return 'nanopub-creator.esm.js';
                  if (format === 'umd') return 'nanopub-creator.js';
                }
              },
              rollupOptions: {
                output: {
                  assetFileNames: (assetInfo) => {
                    if (assetInfo.name === 'style.css') return 'nanopub-creator.css';
                    return assetInfo.name;
                  }
                }
              }
            }
          });
          VITE_EOF
          
          # Build using the library config
          npx vite build --config vite.lib.config.js
          
          cd ../../..
          
          echo "âœ… nanopub-create built successfully"
          ls -lah node_modules/@sciencelivehub/nanopub-create/dist/
      
      - name: Build plugin
        run: npm run build
      
      - name: Verify build
        run: |
          echo "âœ… Build completed successfully!"
          ls -lah build/
          echo ""
          echo "XPI size:"
          du -h build/nanopub.xpi
          
      - name: Upload XPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanopub-plugin-xpi
          path: build/nanopub.xpi
          retention-days: 30
