name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Disable cache to ensure fresh install
          # cache: 'npm'
      
      - name: Clear npm cache and node_modules
        run: |
          echo "üóëÔ∏è Clearing npm cache to ensure fresh dependencies..."
          npm cache clean --force
          rm -rf node_modules
          rm -f package-lock.json
          echo "‚úÖ Cache cleared"
      
      - name: Install dependencies
        run: npm install --no-cache
      
      - name: Build nanopub-view dependency
        run: |
          echo "üì¶ Building nanopub-view library from GitHub..."
          cd node_modules/@sciencelivehub/nanopub-view
          
          npm install
          
          cat > vite.lib.config.js << 'VITE_EOF'
          import { defineConfig } from 'vite';
          import path from 'path';
          
          export default defineConfig({
            build: {
              lib: {
                entry: path.resolve(__dirname, 'src/index.js'),
                name: 'NanopubViewer',
                formats: ['es', 'umd'],
                fileName: (format) => {
                  if (format === 'es') return 'nanopub-viewer.esm.js';
                  if (format === 'umd') return 'nanopub-viewer.js';
                }
              },
              rollupOptions: {
                output: {
                  assetFileNames: (assetInfo) => {
                    if (assetInfo.name === 'style.css') return 'nanopub-viewer.css';
                    return assetInfo.name;
                  }
                }
              }
            }
          });
          VITE_EOF
          
          npx vite build --config vite.lib.config.js
          
          cd ../../..
          
          echo "‚úÖ nanopub-view built successfully"
          ls -lah node_modules/@sciencelivehub/nanopub-view/dist/
          
      - name: Verify nanopub-view build
        run: |
          echo "üîç Verifying nanopub-view build..."
          
          # Log version info
          echo "üì¶ nanopub-view package info:"
          cd node_modules/@sciencelivehub/nanopub-view
          echo "Git commit:"
          git log -1 --oneline 2>/dev/null || echo "  (not a git repo)"
          echo "Package version:"
          cat package.json | grep '"version"' || echo "  (no version found)"
          cd ../..
          
          # Check if critical files exist
          if [ ! -f "node_modules/@sciencelivehub/nanopub-view/dist/nanopub-viewer.esm.js" ]; then
            echo "‚ùå ERROR: nanopub-viewer.esm.js not found!"
            exit 1
          fi
          
          if [ ! -f "node_modules/@sciencelivehub/nanopub-view/dist/nanopub-viewer.css" ]; then
            echo "‚ùå ERROR: nanopub-viewer.css not found!"
            exit 1
          fi
          
          # Check file sizes
          VIEW_JS_SIZE=$(wc -c < "node_modules/@sciencelivehub/nanopub-view/dist/nanopub-viewer.esm.js")
          VIEW_CSS_SIZE=$(wc -c < "node_modules/@sciencelivehub/nanopub-view/dist/nanopub-viewer.css")
          
          echo "üìä Build file sizes:"
          echo "  - nanopub-viewer.esm.js: $VIEW_JS_SIZE bytes"
          echo "  - nanopub-viewer.css: $VIEW_CSS_SIZE bytes"
          
          # Verify files are not too small
          if [ "$VIEW_JS_SIZE" -lt 10000 ]; then
            echo "‚ùå ERROR: nanopub-viewer.esm.js is too small ($VIEW_JS_SIZE bytes)"
            exit 1
          fi
          
          if [ "$VIEW_CSS_SIZE" -lt 1000 ]; then
            echo "‚ùå ERROR: nanopub-viewer.css is too small ($VIEW_CSS_SIZE bytes)"
            exit 1
          fi
          
          echo "‚úÖ nanopub-view verification passed!"
          
      - name: Test nanopub-view import
        run: |
          echo "üß™ Testing if nanopub-view can be imported..."
          node -e "
            try {
              const { NanopubViewer } = require('@sciencelivehub/nanopub-view');
              console.log('‚úÖ NanopubViewer imported successfully');
              console.log('   Constructor type:', typeof NanopubViewer);
              console.log('   Has renderFromUri:', typeof NanopubViewer.prototype.renderFromUri);
              console.log('   Has render:', typeof NanopubViewer.prototype.render);
            } catch (err) {
              console.error('‚ùå Failed to import NanopubViewer:', err.message);
              console.error(err.stack);
              process.exit(1);
            }
          "
      
      - name: Build nanopub-create dependency
        run: |
          echo "üì¶ Building nanopub-create library from GitHub..."
          cd node_modules/@sciencelivehub/nanopub-create
          
          # Install dependencies
          npm install
          
          # Create a temporary library-only vite config
          cat > vite.lib.config.js << 'VITE_EOF'
          import { defineConfig } from 'vite';
          import path from 'path';
          import wasm from 'vite-plugin-wasm';
          import topLevelAwait from 'vite-plugin-top-level-await';
          
          export default defineConfig({
            plugins: [
              wasm(),
              topLevelAwait()
            ],
            build: {
              lib: {
                entry: path.resolve(__dirname, 'src/index.js'),
                name: 'NanopubCreator',
                formats: ['es', 'umd'],
                fileName: (format) => {
                  if (format === 'es') return 'nanopub-creator.esm.js';
                  if (format === 'umd') return 'nanopub-creator.js';
                }
              },
              rollupOptions: {
                output: {
                  assetFileNames: (assetInfo) => {
                    if (assetInfo.name === 'style.css') return 'nanopub-creator.css';
                    return assetInfo.name;
                  }
                }
              }
            }
          });
          VITE_EOF
          
          # Build using the library config
          npx vite build --config vite.lib.config.js
          
          cd ../../..
          
          echo "‚úÖ nanopub-create built successfully"
          ls -lah node_modules/@sciencelivehub/nanopub-create/dist/
      
      - name: Build plugin
        run: npm run build
      
      - name: Verify build
        run: |
          echo "‚úÖ Build completed successfully!"
          ls -lah build/
          echo ""
          echo "üì¶ XPI size:"
          du -h build/nanopub.xpi
          echo ""
          echo "üìã XPI contents (checking for nanopub-view files):"
          unzip -l build/nanopub.xpi | grep -E "(nanopub-viewer|nanopub-creator)" || echo "‚ö†Ô∏è Warning: No nanopub-view/create files found in XPI!"
          echo ""
          echo "üîç Checking if styles directory exists in XPI:"
          unzip -l build/nanopub.xpi | grep "content/styles/" || echo "‚ö†Ô∏è Warning: No styles directory found!"
          echo ""
          echo "üìÑ Full XPI structure:"
          unzip -l build/nanopub.xpi | head -50
          
      - name: Upload XPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanopub-plugin-xpi
          path: build/nanopub.xpi
          retention-days: 30
